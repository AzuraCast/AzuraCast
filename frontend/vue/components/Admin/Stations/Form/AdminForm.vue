<template>
    <b-tab :title="langTabTitle" :title-link-class="tabClass">
        <b-form-group>
            <b-row>
                <b-wrapped-form-group class="col-md-6" id="edit_form_is_enabled" :field="form.is_enabled">
                    <template #description>
                        <translate key="lang_edit_form_is_enabled_desc">If disabled, the station will not broadcast or shuffle its AutoDJ.</translate>
                    </template>
                    <template #default="props">
                        <b-form-checkbox :id="props.id" v-model="props.field.$model">
                            <translate
                                key="lang_edit_form_is_enabled">Enable Broadcasting</translate>
                        </b-form-checkbox>
                    </template>
                </b-wrapped-form-group>

                <b-wrapped-form-group class="col-md-6" id="edit_form_radio_base_dir" :field="form.radio_base_dir"
                                      advanced>
                    <template #label>
                        <translate key="lang_edit_form_radio_base_dir">Base Station Directory</translate>
                    </template>
                    <template #description>
                        <translate key="lang_edit_form_radio_base_dir_desc">The parent directory where station playlist and configuration files are stored. Leave blank to use default directory.</translate>
                    </template>
                </b-wrapped-form-group>
            </b-row>

            <b-overlay variant="card" :show="storageLocationsLoading">
                <b-row>
                    <b-wrapped-form-group class="col-md-12" id="edit_form_media_storage_location_id"
                                          :field="form.media_storage_location_id">
                        <template #label>
                            <translate key="lang_form_media_storage_location_id">Media Storage Location</translate>
                        </template>
                        <template #default="props">
                            <b-form-select :id="props.id" v-model="props.field.$model"
                                           :options="storageLocationOptions.media_storage_location"></b-form-select>
                        </template>
                    </b-wrapped-form-group>

                    <b-wrapped-form-group class="col-md-12" id="edit_form_recordings_storage_location_id"
                                          :field="form.recordings_storage_location_id">
                        <template #label>
                            <translate
                                key="lang_form_recordings_storage_location_id">Live Recordings Storage Location</translate>
                        </template>
                        <template #default="props">
                            <b-form-select :id="props.id" v-model="props.field.$model"
                                           :options="storageLocationOptions.recordings_storage_location"></b-form-select>
                        </template>
                    </b-wrapped-form-group>

                    <b-wrapped-form-group class="col-md-12" id="edit_form_podcasts_storage_location_id"
                                          :field="form.podcasts_storage_location_id">
                        <template #label>
                            <translate
                                key="lang_form_podcasts_storage_location_id">Podcasts Storage Location</translate>
                        </template>
                        <template #default="props">
                            <b-form-select :id="props.id" v-model="props.field.$model"
                                           :options="storageLocationOptions.podcasts_storage_location"></b-form-select>
                        </template>
                    </b-wrapped-form-group>
                </b-row>
            </b-overlay>
        </b-form-group>
    </b-tab>
</template>

<script>
import BWrappedFormGroup from "~/components/Form/BWrappedFormGroup";
import objectToFormOptions from "~/functions/objectToFormOptions";

export default {
    name: 'AdminStationsAdminForm',
    components: {BWrappedFormGroup},
    props: {
        form: Object,
        tabClass: {},
        isEditMode: Boolean,
        storageLocationApiUrl: String
    },
    data() {
        return {
            storageLocationsLoading: true,
            storageLocationOptions: {
                media_storage_location: [],
                recordings_storage_location: [],
                podcasts_storage_location: []
            }
        }
    },
    mounted() {
        this.loadLocations();
    },
    computed: {
        langTabTitle() {
            return this.$gettext('Administration');
        },
    },
    methods: {
        loadLocations() {
            this.axios.get(this.storageLocationApiUrl).then((resp) => {
                this.storageLocationOptions.media_storage_location = objectToFormOptions(
                    this.filterLocations(resp.data.media_storage_location)
                );
                this.storageLocationOptions.recordings_storage_location = objectToFormOptions(
                    this.filterLocations(resp.data.recordings_storage_location)
                );
                this.storageLocationOptions.podcasts_storage_location = objectToFormOptions(
                    this.filterLocations(resp.data.podcasts_storage_location)
                );
            }).finally(() => {
                this.storageLocationsLoading = false;
            });
        },
        filterLocations(group) {
            if (!this.isEditMode) {
                return group;
            }

            let newGroup = {};
            for (const oldKey in group) {
                if (oldKey !== "") {
                    newGroup[oldKey] = group[oldKey];
                }
            }
            return newGroup;
        }
    }
}
</script>
