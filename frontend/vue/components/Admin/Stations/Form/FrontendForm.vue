<template>
    <div class="row g-3 mb-3">
        <form-group-multi-check
            id="edit_form_frontend_type"
            class="col-md-12"
            :field="form.frontend_type"
            :options="frontendTypeOptions"
            stacked
            radio
            :label="$gettext('Broadcasting Service')"
            :description="$gettext('This software delivers your broadcast to the listening audience.')"
        />
    </div>

    <template v-if="isLocalFrontend">
        <div
            v-if="isShoutcastFrontend"
            class="row g-3 mb-3"
        >
            <form-group-field
                id="edit_form_frontend_sc_license_id"
                class="col-md-6"
                :field="form.frontend_config.sc_license_id"
                :label="$gettext('Shoutcast License ID')"
            />

            <form-group-field
                id="edit_form_frontend_sc_user_id"
                class="col-md-6"
                :field="form.frontend_config.sc_user_id"
                :label="$gettext('Shoutcast User ID')"
            />
        </div>

        <div class="row g-3 mb-3">
            <form-group-field
                id="edit_form_frontend_source_pw"
                class="col-md-6"
                :field="form.frontend_config.source_pw"
                :label="$gettext('Customize Source Password')"
                :description="$gettext('Leave blank to automatically generate a new password.')"
            />

            <form-group-field
                id="edit_form_frontend_admin_pw"
                class="col-md-6"
                :field="form.frontend_config.admin_pw"
                :label="$gettext('Customize Administrator Password')"
                :description="$gettext('Leave blank to automatically generate a new password.')"
            />

            <form-group-field
                v-if="showAdvanced"
                id="edit_form_frontend_port"
                class="col-md-6"
                :field="form.frontend_config.port"
                input-type="number"
                :input-attrs="{min: '0'}"
                advanced
                :label="$gettext('Customize Broadcasting Port')"
                :description="$gettext('No other program can be using this port. Leave blank to automatically assign a port.')"
            />

            <form-group-field
                v-if="showAdvanced"
                id="edit_form_max_listeners"
                class="col-md-6"
                :field="form.frontend_config.max_listeners"
                advanced
                :label="$gettext('Maximum Listeners')"
                :description="$gettext('Maximum number of total listeners across all streams. Leave blank to use the default.')"
            />
        </div>

        <div
            v-if="showAdvanced"
            class="row g-3 mb-3"
        >
            <div class="col-md-5">
                <form-group-field
                    id="edit_form_frontend_banned_ips"
                    :field="form.frontend_config.banned_ips"
                    input-type="textarea"
                    :input-attrs="{class: 'text-preformatted'}"
                    advanced
                    :label="$gettext('Banned IP Addresses')"
                    :description="$gettext('List one IP address or group (in CIDR format) per line.')"
                />

                <form-group-field
                    id="edit_form_frontend_allowed_ips"
                    :field="form.frontend_config.allowed_ips"
                    input-type="textarea"
                    :input-attrs="{class: 'text-preformatted'}"
                    advanced
                    :label="$gettext('Allowed IP Addresses')"
                    :description="$gettext('List one IP address or group (in CIDR format) per line.')"
                />

                <form-group-field
                    id="edit_form_frontend_banned_user_agents"
                    :field="form.frontend_config.banned_user_agents"
                    input-type="textarea"
                    :input-attrs="{class: 'text-preformatted'}"
                    advanced
                    :label="$gettext('Banned User Agents')"
                    :description="$gettext('List one user agent per line. Wildcards (*) are allowed.')"
                />
            </div>

            <div class="col-md-7">
                <form-group-select
                    id="edit_form_frontend_banned_countries"
                    :field="form.frontend_config.banned_countries"
                    :options="countryOptions"
                    advanced
                    multiple
                    :label="$gettext('Banned Countries')"
                    :description="$gettext('Select the countries that are not allowed to connect to the streams.')"
                />

                <div class="block-buttons">
                    <button
                        class="btn btn-block btn-primary"
                        @click.prevent="clearCountries"
                    >
                        {{ $gettext('Clear List') }}
                    </button>
                </div>
            </div>
        </div>

        <form-fieldset v-if="showAdvanced">
            <template #label>
                {{ $gettext('Custom Configuration') }}
            </template>
            <template #description>
                {{ $gettext('This code will be included in the frontend configuration. Allowed formats are:') }}
                <ul>
                    <li>JSON: <code>{"new_key": "new_value"}</code></li>
                    <li>XML: <code>&lt;new_key&gt;new_value&lt;/new_key&gt;</code></li>
                </ul>
            </template>

            <div class="row g-3">
                <form-group-field
                    id="edit_form_frontend_custom_config"
                    class="col-md-12"
                    :field="form.frontend_config.custom_config"
                    input-type="textarea"
                    :input-attrs="{class: 'text-preformatted', spellcheck: 'false', 'max-rows': 25, rows: 5}"
                    advanced
                    :label="$gettext('Custom Configuration')"
                />
            </div>
        </form-fieldset>
    </template>
</template>

<script setup>
import FormFieldset from "~/components/Form/FormFieldset";
import FormGroupField from "~/components/Form/FormGroupField.vue";
import {FRONTEND_ICECAST, FRONTEND_REMOTE, FRONTEND_SHOUTCAST} from "~/components/Entity/RadioAdapters";
import objectToFormOptions from "~/functions/objectToFormOptions";
import {computed} from "vue";
import {useTranslate} from "~/vendor/gettext";
import FormGroupMultiCheck from "~/components/Form/FormGroupMultiCheck.vue";
import FormGroupSelect from "~/components/Form/FormGroupSelect.vue";

const props = defineProps({
    form: {
        type: Object,
        required: true
    },
    isShoutcastInstalled: {
        type: Boolean,
        default: false
    },
    countries: {
        type: Object,
        required: true
    },
    showAdvanced: {
        type: Boolean,
        default: true
    },
});

const {$gettext} = useTranslate();

const frontendTypeOptions = computed(() => {
    let frontendOptions = [
        {
            text: $gettext('Use Icecast 2.4 on this server.'),
            value: FRONTEND_ICECAST
        },
    ];

    if (props.isShoutcastInstalled) {
        frontendOptions.push({
            text: $gettext('Use Shoutcast DNAS 2 on this server.'),
            value: FRONTEND_SHOUTCAST
        });
    }

    frontendOptions.push({
        text: $gettext('Only connect to a remote server.'),
        value: FRONTEND_REMOTE
    });

    return frontendOptions;
});

const countryOptions = computed(() => {
    return objectToFormOptions(props.countries);
});

const isLocalFrontend = computed(() => {
    return props.form.frontend_type.$model !== FRONTEND_REMOTE;
});

const isShoutcastFrontend = computed(() => {
    return props.form.frontend_type.$model === FRONTEND_SHOUTCAST;
});

const clearCountries = () => {
    props.form.frontend_config.banned_countries.$model = [];
}
</script>
