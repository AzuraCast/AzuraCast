---
- name: Clear OPAM directory
  file:
    path: "{{ app_base }}/.opam"
    state: absent

- name: Add OPAM/OCaml Repository
  apt_repository:
    repo: "ppa:avsm/ppa"
    update_cache: true

- name: Install Liquidsoap Dependencies
  apt:
    name: "{{ azuracast_liquidsoap_system_packages }}"
    install_recommends: false

- name: Init opam directory
  command: >-
    opam init -a --disable-sandboxing --bare
  become_user: azuracast
  args:
    chdir: "{{ app_base }}"
  changed_when: false

- name: Gather directory opam switch state    # noqa risky-shell-pipe
  shell: >-
    opam switch list | grep -v "^#" | grep -v "^$" | tr -s " "
  become_user: azuracast
  args:
    chdir: "{{ app_base }}"
  changed_when: false
  register:
    _azuracast_opam_switch_list_sh

- name: Cook variable
  set_fact:
    _azuracast_opam_switch_needs_creation: >-
      {{ (_azuracast_opam_switch_list_sh.stdout_lines | length) == 0 }}

- name: Initialize OPAM
  become_user: azuracast
  command: >-
    opam switch create 4.12.0
  args:
    chdir: "{{ app_base }}"
  when: _azuracast_opam_switch_needs_creation

- name: Build and Install Liquidsoap and Dependencies
  become_user: azuracast
  shell: >-
    opam switch set 4.12.0 &&
    opam install -y ladspa.0.2.0 ffmpeg.1.1.1 ffmpeg-avutil.1.1.1 ffmpeg-avcodec.1.1.1 ffmpeg-avdevice.1.1.1
    ffmpeg-av.1.1.1 ffmpeg-avfilter.1.1.1 ffmpeg-swresample.1.1.1 ffmpeg-swscale.1.1.1 frei0r.0.1.2 samplerate.0.1.6
    taglib.0.3.7 mad.0.5.0 faad.0.5.0 fdkaac.0.3.2 lame.0.3.5 vorbis.0.8.0 cry.0.6.5 flac.0.3.0 opus.0.2.0 dtools.0.4.4
    duppy.0.9.2 ocurl.0.9.1 ssl liquidsoap.2.0.2
  args:
    chdir: "{{ app_base }}"
  register: install_result
  async: 3600
  poll: 0

- name: Check on Liquidsoap Installation
  become_user: azuracast
  async_status:
    jid: "{{ install_result.ansible_job_id }}"
  register: check_result
  until: check_result.finished
  retries: 360
  delay: 10

- name: Link Liquidsoap binary
  file:
    src: "{{ app_base }}/.opam/4.12.0/bin/liquidsoap"
    dest: /usr/local/bin/liquidsoap
    state: link
    force: true
