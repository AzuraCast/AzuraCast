---
- name: Add PHP PPA repository
  apt_repository:
    repo: "ppa:ondrej/php"
    update_cache: true

- name: Gather existing php version    # noqa: risky-shell-pipe
  shell: >-
    (php -v | head -n 1 | cut -d " " -f2) || echo 0.0.0
  changed_when: false
  register:
    _php_current_version_sh

- name: Cook variables
  set_fact:
    php_expected_version_found: "{{ _php_current_version_sh.stdout is match(php_version + '.*') }}"

- name: Remove unexpected php
  apt:
    name: "php*"
    state: absent
  when: not php_expected_version_found

- name: Install php
  apt:
    name: "{{ php_sys_packages }}"
    state: present

- name: Configure PHP FPM Pool
  template:
    src: fpmpool.j2
    dest: "/etc/php/{{ php_version }}/fpm/pool.d/www.conf"
    force: true
    mode: 0644

- name: Configure php-fpm php.ini
  ini_file:
    dest: "/etc/php/{{ php_version }}/fpm/php.ini"
    section: PHP
    option: "{{ _current_php_init_option.option }}"
    value: "{{ _current_php_init_option.value }}"
    mode: 0644
  loop:
    - option: "post_max_size"
      value: "50M"
    - option: "short_open_tag"
      value: "On"
    - option: "upload_max_filesize"
      value: "50M"
  loop_control:
    loop_var: _current_php_init_option

- name: Configure php-cli php.ini
  ini_file:
    dest: "/etc/php/{{ php_version }}/cli/php.ini"
    section: PHP
    option: "short_open_tag"
    value: "On"
    mode: 0644
